#  Copyright (c) 2021 Cristian Patrasciuc. All rights reserved.
#  Use of this source code is governed by a BSD-style license that can be
#  found in the LICENSE file.

name: Build Windows Executable

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
      - name: Set up Python 3.9
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Build Cython modules
        run: |
          cd src && python setup.py build_ext --inplace --force
      - name: Package the app as a stand-alone Windows executable
        run: |
          python -OO -m PyInstaller -F --clean -y --debug=all main.spec
          $filename = Get-ChildItem dist -Name
          Write-Output "::set-env name=ARTIFACT_FILE_NAME::$filename"
        env:
          PYTHONIOENCODING: utf-8:backslashreplace
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.ARTIFACT_FILE_NAME }}
          path: dist/${{ env.ARTIFACT_FILE_NAME }}
