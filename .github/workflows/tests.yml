#  Copyright (c) 2021 Cristian Patrasciuc. All rights reserved.
#  Use of this source code is governed by a BSD-style license that can be
#  found in the LICENSE file.

name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install X server
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get install fluxbox xinit xterm
    - name: Start X server
      if: matrix.os == 'ubuntu-latest'
      run: |
        ls /etc/init.d/lightdm
        startx
        echo $DISPLAY
    # https://kivy.readthedocs.io/en/master/installation/installation-linux.html
    - name: Install Ubuntu pakcages
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get install libmtdev1 libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Set environment variables
      run: |
        echo "DISPLAY=:0.0" >> $GITHUB_ENV
        echo "PYTHONIOENCODING=utf-8" >> $GITHUB_ENV
        echo "PYTHONLEGACYWINDOWSSTDIO=utf-8" >> $GITHUB_ENV
    - name: Run all tests on ${{ matrix.os }}
      run: |
        echo $DISPLAY $PYTHONIOENCODING $PYTHONLEGACYWINDOWSSTDIO
        cd src && DISPLAY=":0.0" python run_test_coverage.py
